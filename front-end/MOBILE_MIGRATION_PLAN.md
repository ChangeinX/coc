# Mobile Migration Plan

This checklist tracks migrating the PWA to a React Native app (iOS/Android) using a skeleton-first approach and feature-based structure.

## Decisions
- [x] Stack: Expo (SDK 53, RN 0.79)
- [x] Navigation: React Navigation (stack + tabs)
- [x] Data: TanStack Query 5; local state: Zustand 5
- [x] Storage: MMKV (cache), Secure storage for tokens; Biometrics optional (Expo plugins or native module)
- [ ] UI kit/design system selection (Paper/NativeWind/Tamagui/etc.)

## Repo Layout
- [x] Keep web app under `front-end/app`
- [x] Create `front-end/mobile` (RN app)
- [x] Convert `front-end/mobile` to Expo managed (prebuild)
- [ ] (Optional) Add shared packages `front-end/packages/{core,api,ui}`

## Foundations
- [x] Scaffold RN app with TypeScript template (`front-end/mobile`)
- [x] Configure ESLint/Prettier/TS strict
- [x] Set up basic folder structure (feature-based)
- [x] Add app providers (QueryClientProvider, theme, state)
- [x] Implement secure storage helpers (Keychain/MMKV)

### Directory Structure (initial)
```
front-end/mobile/
  app.config.ts            # Expo config (reads env, app metadata)
  package.json
  babel.config.js
  tsconfig.json
  .eslintrc.cjs
  .prettierrc
  metro.config.js
  ios/                     # generated by prebuild
  android/                 # generated by prebuild
  src/
    App.tsx                # entry; wraps Providers and RootNavigator
    navigation/
      RootNavigator.tsx    # stacks + tabs
      linking.ts           # deep link config (cocdash://)
      types.ts             # navigation param types
    features/
      auth/
        screens/
          LoginScreen.tsx
          BannedScreen.tsx
        api/auth.api.ts
        hooks/useAuth.ts
        types.ts
      dashboard/
        screens/DashboardScreen.tsx
        components/KPI.tsx
        api/dashboard.api.ts
      messages/
      scout/
      stats/
      settings/
    components/            # cross-feature UI pieces
      ui/
    services/
      apiClient.ts         # fetch/axios wrapper + interceptors
      storage/
        mmkv.ts            # MMKV instance + helpers
        secureStorage.ts   # tokens via Keychain/SecureStore
      notifications/
        push.ts            # register, handle, deep links
      analytics.ts
      logger.ts
    store/                 # Zustand stores
      auth.store.ts
      settings.store.ts
    theme/
      index.ts             # theme object(s)
      light.ts
      dark.ts
    lib/
      queryClient.ts       # TanStack Query client
      i18n.ts              # (optional) internationalization setup
    utils/
    constants/
    env.ts                 # typed env access via expo-constants
    types/
  tests/
    unit/
    e2e/                   # Detox skeleton
```

### Tooling & Config
- [x] TypeScript: `strict: true`, `noImplicitAny`, `exactOptionalPropertyTypes`, path aliases `@features/*`, `@services/*`.
- [x] ESLint: `@react-native`, `@typescript-eslint`, `eslint-plugin-import`, React rules aligned with RN.
- [x] Prettier: 2-space, trailing commas, single quotes.
- [x] Jest: `react-native` preset (moduleNameMapper set for aliases).
- [ ] Detox: basic device config + two smoke flows (login, tab switch).

### App Providers & Shell
- [x] Wrap `App.tsx` with: `QueryClientProvider`, `ThemeProvider` (UI kit TBD), `SafeAreaProvider`, and top-level `Zustand` stores.
- [x] Initialize `queryClient` with sane defaults (retry/backoff, staleTime, error boundaries later).
- [x] Theme: light/dark palettes, system preference hook, persist choice in MMKV.

### Storage & Security
- [x] Define `TokenStorage` interface (get/set/clear, isBiometricEnabled).
- [x] Implement tokens in Secure storage: `react-native-keychain` or `expo-secure-store` (fallback only in dev).
- [x] Use MMKV for caches and lightweight persisted UI state; never store tokens in MMKV.
- [ ] Optional: biometrics gate for unlock (Keychain access control / Expo local-auth).

### Env & Networking
- [x] Environment: read base URLs from `app.config.ts` and `expo-constants` (`ENV=dev|staging|prod`).
- [x] `apiClient`: attach auth header from secure storage; cancellation support; (401 refresh/backoff to be extended).
- [ ] React Query: centralized `onError` + toasts/snackbars via theme kit.

### Authentication & Identity (OIDC via user_service)
- [x] Decision: user_service (Spring) as OIDC issuer; Apple first
- [x] iOS library: `expo-apple-authentication` (native)
- [ ] Android library/flow: `expo-auth-session` via Hosted UI (later)
- [ ] Add env to `app.config.ts` (`extra`): `AUTH_URL` (user_service base), `APP_SCHEME`, `REDIRECT_URI`, `LOGOUT_REDIRECT_URI`, `OIDC_ISSUER`
- [ ] user_service: implement endpoints
  - `POST /api/v1/auth/apple/exchange` (verify Apple ID token, mint tokens)
  - `POST /api/v1/oauth2/token` (refresh)
  - `POST /api/v1/oauth2/revoke` (revoke)
  - `GET /api/v1/oauth2/jwks.json` (JWKS)
  - (Phase 2) `/.well-known/openid-configuration`, `/oauth2/authorize`, `/userinfo`
- [ ] Key mgmt: RS256 keys + rotation; publish JWKS
- [ ] Mobile iOS: implement Apple sign-in + exchange; secure storage
- [ ] Mobile: implement refresh + logout
- [ ] Android: Hosted UI + PKCE to support Apple web flow

See `front-end/MOBILE_AUTH_MIGRATION.md` for the full plan and infra notes.

### Errors, Logging, Observability
- [ ] Global error boundary screen + per-screen fallbacks.
- [ ] Logger abstraction with console/devtools in dev and noop/remote in prod.
- [ ] Network inspector enabled in dev only.

### Accessibility & i18n
- [ ] A11y labels/roles on navigational elements, large text support, contrast check in theme.
- [ ] Optional i18n skeleton (`i18next`) with minimal translation pipeline.

### Performance Baselines
- [ ] Enable Hermes, measure cold start, navigation latency, initial bundle size.
- [ ] Turn on React Profiler in dev, disable dev logs in prod builds.

Acceptance for Foundations: project boots on device/simulator, navigates between empty tabs, persists theme, authenticates against dev API with secure token storage, and has lint/type/test baselines passing.

## Navigation Skeleton
- [x] Root navigator with deep linking (`clanboards://`)
- [x] AuthStack: Login, Banned
- [x] AppTabs: Dashboard, Messages, Scout, Stats, Settings
- [x] Nested stacks for Messages (Settings remains single-screen for now)

## Feature Migration
- [ ] Auth flow (iOS: native Apple + exchange; Android: Hosted UI) + refresh
- [ ] Dashboard KPIs (from `Dashboard.jsx`)
- [ ] Messages threads/detail + realtime (from `ChatPage.jsx`)
- [ ] Notifications + deep links (from `PushDebug.jsx`)
- [ ] Scout feature (from `Scout.jsx`)
- [ ] Stats feature (from `Stats.jsx`)
- [ ] Account/Settings (from `Account.jsx`)

## Data & APIs
- [ ] API client with interceptors, retry/backoff
- [ ] (Optional) Codegen clients/types (OpenAPI/GraphQL) into `packages/api`
- [ ] React Query persist with MMKV

## Quality & DX
- [ ] Unit/UI tests (Jest + @testing-library/react-native)
- [ ] E2E tests (Detox) for critical flows
- [ ] Husky + lint-staged; CI for lint, typecheck, tests

## Build & Release
- [x] iOS build (Debug): Expo prebuild + `xcodebuild` (ClashMobile scheme)
- [ ] Android build (Debug): `expo run:android` or `./android/gradlew assembleDebug`
  - Note: Android SDK not detected on this machine (no `~/Library/Android/sdk`). Install Android Studio or set `ANDROID_HOME`/`sdk.dir`.
  - Updated app name: Clan Boards; bundle IDs: `com.clanboards.app`; scheme: `clanboards`.
- [ ] Configure signing, store metadata, beta tracks (TestFlight/Internal sharing)

## Backend API Route Translations

As the Python Flask backend is migrated to Java microservices, the following endpoints are being moved. Update mobile API calls to use the new endpoints as they become available.

### Assets (âœ… Already Migrated)
- **OLD**: `/api/v1/assets/?url=<url>` 
- **NEW**: `/api/v1/clan-data/assets/?url=<url>`

### War Data (âœ… Already Migrated)
- **OLD**: `/api/v1/war/<clan_tag>/current`
- **NEW**: `/api/v1/clan-data/wars/<clan_tag>/current`

### Player Data (âœ… Already Migrated)
- **OLD**: `/api/v1/player/<tag>`
- **NEW**: `/api/v1/clan-data/players/<tag>`
- **OLD**: `/api/v1/player/by-user/<sub>`
- **NEW**: `/api/v1/clan-data/players/by-user/<sub>` (Note: requires user service integration)

### Invitations (âœ… Already Migrated)
- **OLD**: `/invite/<player_id>` (POST)
- **NEW**: `/api/v1/notifications/invites/<player_id>` (POST)
- **Note**: Requires `X-User-Id` header for authentication

### User Profile (ðŸš« Skipped)
- **NOTE**: `/verify` Not migrated (waiting internal java libraray creation)

## Notes
- Start simple: Hello World + navigation shell, then port features incrementally.
- Keep web app fully functional during migration; share logic via packages where feasible.
- Test against both old and new endpoints during backend transition period
